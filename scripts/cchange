
#!/bin/bash

while true; do
    # Main menu
    main_menu="Keyboard Layout\nRight Alt → Escape\nQuit"
    main_choice=$(echo "$main_menu" | rofi -dmenu -p "Select Option")

    case "$main_choice" in
        "Keyboard Layout")
            # Detect current option
            current_option=$(setxkbmap -query | grep options | awk '{print $2}')

            # Layout menu
            layout_menu="Normal Layout\nSwap Ctrl ↔ Caps Lock\nCaps Lock as Ctrl"

            # Preselect depending on current option
            if [[ "$current_option" == "ctrl:swapcaps" ]]; then
                choice=$(echo "$layout_menu" | rofi -dmenu -p "Keyboard Layout" -selected-row 1)
            elif [[ "$current_option" == "ctrl:nocaps" ]]; then
                choice=$(echo "$layout_menu" | rofi -dmenu -p "Keyboard Layout" -selected-row 2)
            else
                choice=$(echo "$layout_menu" | rofi -dmenu -p "Keyboard Layout" -selected-row 0)
            fi

            # Apply layout choice
            case "$choice" in
                "Normal Layout")
                    setxkbmap -option
                    notify-send "Keyboard Layout" "Now using Normal layout"
                    ;;
                "Swap Ctrl ↔ Caps Lock")
                    setxkbmap -option ctrl:swapcaps
                    notify-send "Keyboard Layout" "Swapped Ctrl ↔ Caps Lock"
                    ;;
                "Caps Lock as Ctrl")
                    setxkbmap -option ctrl:nocaps
                    notify-send "Keyboard Layout" "Caps Lock is now Ctrl"
                    ;;
            esac
            ;;

        "Right Alt → Escape")
            # Check current mapping
            current=$(xmodmap -pke | grep -w "keycode 108" | grep "Escape" 2>/dev/null)

            # Rofi menu options
            options="Enable\nDisable\nQuit"
            choice=$(echo "$options" | rofi -dmenu -p "Right Alt → Escape")

            case "$choice" in
                Enable)
                    xmodmap -e "keycode 108 = Escape"
                    notify-send "Key Remap" "Right Alt → Escape enabled"
                    ;;
                Disable)
                    xmodmap -e "keycode 108 = Alt_R"
                    notify-send "Key Remap" "Right Alt restored"
                    ;;
                Quit|*)
                    continue
                    ;;
            esac
            ;;

        "Quit"|*)
            exit 0
            ;;
    esac
done

#!/usr/bin/env bash

# Function to handle keyboard layout
keyboard_layout_menu() {
    local current_option
    current_option=$(setxkbmap -query | awk '/options/ {print $2}')

    local layout_menu="Normal Layout\nSwap Ctrl ↔ Caps Lock\nCaps Lock as Ctrl"
    local preselect=0

    case "$current_option" in
    "ctrl:swapcaps") preselect=1 ;;
    "ctrl:nocaps") preselect=2 ;;
    esac

    local choice
    choice=$(echo -e "$layout_menu" | rofi -dmenu -p "Keyboard Layout" -selected-row "$preselect")

    case "$choice" in
    "Normal Layout")
        setxkbmap -option
        notify-send "Keyboard Layout" "Now using Normal layout"
        ;;
    "Swap Ctrl ↔ Caps Lock")
        setxkbmap -option ctrl:swapcaps
        notify-send "Keyboard Layout" "Swapped Ctrl ↔ Caps Lock"
        ;;
    "Caps Lock as Ctrl")
        setxkbmap -option ctrl:nocaps
        notify-send "Keyboard Layout" "Caps Lock is now Ctrl"
        ;;
    esac
}

# Function to handle Right Alt → Escape
right_alt_escape_menu() {
    local current
    current=$(xmodmap -pke | awk '/keycode 108/ {print $4}' 2>/dev/null)

    local options="Enable\nDisable\nQuit"
    local choice
    choice=$(echo -e "$options" | rofi -dmenu -p "Right Alt → Escape")

    case "$choice" in
    Enable)
        xmodmap -e "keycode 108 = Escape"
        notify-send "Key Remap" "Right Alt → Escape enabled"
        ;;
    Disable)
        xmodmap -e "keycode 108 = Alt_R"
        notify-send "Key Remap" "Right Alt restored"
        ;;
    esac
}

# Main loop
while true; do
    main_menu="Keyboard Layout\nRight Alt → Escape\nQuit"
    main_choice=$(echo -e "$main_menu" | rofi -dmenu -p "Select Option")

    case "$main_choice" in
    "Keyboard Layout") keyboard_layout_menu ;;
    "Right Alt → Escape") right_alt_escape_menu ;;
    "Quit" | *) exit 0 ;;
    esac
done
